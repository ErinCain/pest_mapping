---
title: "joining of counties"
author: "Erin Cain"
date: "2/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(echo = TRUE,
                      root.dir = "/Users/ErinCain/Documents/pest_mapping/")
library(sf)
library(sp)
library(readtext)
library(tidyverse)
library(dplyr)
library(tidyverse)
library(readr)
```


```{r}

create_dataframe <- function(file_1, file_2) {
  pest_data <- read.csv(file = file_1)
  pest_data <- pest_data %>% 
    select(use_no, chem_code, lbs_chm_used, applic_dt, county_cd, base_ln_mer,
           township, tship_dir, range, range_dir, section,
           CO_MTR = comtrs) %>% 
    na.omit()

  #pest_data$county_cd <- sprintf("%02d", as.numeric(pest_data$county_cd))
  #pest_data$township <- sprintf("%02d", as.numeric(pest_data$township))
  #pest_data$range <- sprintf("%02d", as.numeric(pest_data$range))


  #pest_data$CO_MTR = paste(pest_data$county_cd, pest_data$base_ln_mer,
  #                                pest_data$township, pest_data$tship_dir,
  #                                as.character(pest_data$range), pest_data$range_dir, sep="")

  

  townships <- st_read(dsn = file_2, quiet = T)
  
  merged <- full_join(townships, pest_data, by='CO_MTR')
  colnames(merged)[3:4] <- c("TownshipMTR", "MTR_ID")
  return(merged)
}
#file_1 = 'data/pur2017/udc17_04.txt'
#file_2 = "data/townships/Butte_townships/mtr_04_nad83.shp"

#create_dataframe('pur2017/udc17_04.txt', "townships/Butte_townships/mtr_04_nad83.shp")
```

```{r}

shapes_list <-c('data/pur2017/udc17_04.txt', 'data/pur2017/udc17_11.txt',
                'data/pur2017/udc17_17.txt', 'data/pur2017/udc17_32.txt',
                'data/pur2017/udc17_45.txt', 'data/pur2017/udc17_51.txt',
                'data/pur2017/udc17_52.txt', 'data/pur2017/udc17_57.txt',
                'data/pur2017/udc17_58.txt')

pest_list <-c('data/townships/Butte_townships/mtr_04_nad83.shp',
              'data/townships/Glenn_townships/mtr_11_nad83.shp',
              'data/townships/Lake_townships/mtr_17_nad83.shp',
              'data/townships/Plumas_townships/mtr_32_nad83.shp',
              'data/townships/Shasta_townships/mtr_45_nad83.shp',
              'data/townships/Sutter_townships/mtr_51_nad83.shp',
              'data/townships/Tehama_townships/mtr_52_nad83.shp',
              'data/townships/Yolo_townships/mtr_57_nad83.shp',
              'data/townships/Yuba_townships/mtr_58_nad83.shp')


list_tables <- mapply(create_dataframe, shapes_list, pest_list, SIMPLIFY = FALSE)
sac_counties <- do.call('rbind', list_tables)
```

```{r}
length(unique(sac_counties$CO_MTR))
length(unique(sac_counties$geometry))

combined_comtr <- sac_counties %>%  
  group_by(CO_MTR) %>% 
  summarise(lbs_applied_total = sum(lbs_chm_used, na.rm = T))
```


```{r}
library(leaflet)
s.sf <- combined_comtr
colors <- c('#fed98e', '#fe9929', '#d95f0e', '#993404')
mypalette <- colorBin(palette = colors, domain = s.sf$lbs_applied_total)
popup <- paste0("Township:", s.sf$CO_MTR, "Pounds Chemicals Applied", s.sf$lbs_applied_total)
combined_comtr_projected <- sf::st_transform(s.sf, '+proj=longlat +datum=WGS84')

leaflet(combined_comtr_projected) %>%
  addProviderTiles("CartoDB.Positron" ) %>%
  addPolygons(stroke = FALSE, 
              smoothFactor = .2,
              fillOpacity = .8, 
              popup = popup, 
              color = ~ mypalette(s.sf$lbs_applied_total))
```









